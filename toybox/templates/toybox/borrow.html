{% extends "toybox/base.html" %}
{% load widget_tweaks %}
{% block content %}

<h1  id="page_table" class="page-header">Borrow Toy</h1>

<div id="member" class="row" >

    <div   class="col-xs-11 col-sm-10 ">

           {% include "toybox/member_search.html" %}
           {% include "toybox/member_search_select.html" with return_page="/toybox/borrow"%}

    </div>
    <div   class="col-xs-1" >

        <a href="{% url 'toybox:members' %}"><button title="Add New Member" type="button" class="btn btn-success" aria-label="Left Align">
        <span class="glyphicon glyphicon-plus " aria-hidden="true"></span><span class="glyphicon glyphicon-user " aria-hidden="true"></span></button></a>

    </div>
</div>

<div class="row" >
      <div class="col-xs-12 col-sm-10 " style="margin-left: 20px; ">
        <br>
           {% if members == None %}
                {% include "toybox/member_summary.html" %}
          {% endif %}
        <br>
      </div>

</div>
<p id="demo"></p>

<div id="toy" class="row">
 <!--TODO change to form that doesn't use URL attributes - clicking on toy reborrows the toy-->
    <div   class="col-xs-12 col-sm-10 ">
        {% include "toybox/toy_search.html" %}
    </div>

</div>

    {% if toy %}
   <div class="row panel-fluid panel-default" style=" min-height:180px; ">
   {%else%}
     <div class="row panel-fluid panel-default" >
   {% endif %}

         <div   class="col-sm-3 col-xs-12">
            {% if toy != None %}
            <!--TODO include toy image in context-->
             <!--<img class="pull-left img-thumbnail"   src="{{ toy.image }}">-->
                <img class="pull-left img-thumbnail"  style=" max-height:150px;" src="/static/toybox/MTB logo.png">
            {% endif %}
       </div>

        <div   class="col-sm-8 col-xs-12 " style="margin-left: 20px;">
            {% if toy != None %}
                 {% include "toybox/toy_summary.html" %}
            {% endif %}
       </div>


    </div>



<div id="transaction"  class="row">
    <div class="panel-fluid panel-default col-xs-12 col-sm-10 ">

              <div class="panel-heading">Borrowed Toys</div>

              <!-- Table -->
              <table class="table" id="toy_table">

                    <thead>
                        <tr>
                            <th>Toy ID</th>
                        	<th>Toy Description</th>
                            <th>Due In (days)</th>
                            <th>Borrow Fee</th>
                            <th>Remove</th>
                       	</tr>
                    </thead>

                   {% for t in toy_list %}
                   <tr>
                        <td>
                            <a href="{% url 'toybox:borrow' %}{{member.id}}/?tc={{t.code}}" >{{ t.code }}</a>
                            {% if t.borrow_date == today.date %}
                                <span class="label label-success label-as-badge">New</span>
                            {% endif %}
                        </td>

                        <td>{{ t.description }}</td>

                        <td>

                            <span class="label {% if t.due_in < 0 %} label-danger {%else%} label-success {%endif%} label-as-badge">{{ t.due_in}}</span>

                        </td>


                       <td>
                       {% if t.borrow_date == today.date %}
                            $<span name="fee" value="{{t.fee}}">{{ t.fee|floatformat:2}}</span>
                       {% else %}
                           N/A
                       {% endif %}
                       </td>


                        <td>

                            <button title="Remove this toy from list" type="button" class="btn btn-danger" aria-label="Left Align" {% if t.borrow_date != today.date %} disabled {% endif %}>
                                <span class="glyphicon glyphicon-trash " aria-hidden="true"></span>
                            </button>

                        </td>
                     </tr>
                     {% endfor %}
              </table>
        </div>


</div>


 <form role="form" action="{% url 'toybox:borrow' %}" class="form-group" method='post'>
    {% csrf_token %}

    <div class="row" style=" min-height: 80px;margin-left: 0px;" >
        <div class="input-group  col-xs-12 col-sm-10 ">

            <span type="text" id="duration_title" title="Loan Duration in weeks for all newly borrowed toys" class="input-group-addon">Loan Duration in weeks</span>

              <div class="btn-group " data-toggle="buttons" id="loanDurationRadioGroup">

                  {% for item in payment_form.loan_duration %}
                        <label class="btn btn-default{% if 'checked' in item.render %} active {% endif %}">{{ item }}</label>
                  {% endfor %}

              </div>
        </div>

    </div>

<!--TODO show member balance as a result - above?-->
<!--TODO send back actual fee due and fee paid. Update member balance-->

    <div class="row" style=" min-height: 80px;" >
        <div class="input-group panel-fluid panel-default col-xs-12 col-sm-10 {%if payment_form.fee_due.errors %} has-error {%endif%} ">
              <span class="input-group-addon">Fee Due $</span>

                {% render_field payment_form.fee_due class+="form-control" id="fee_due"%}

              <!--<input id="fee_due" type="text" class="form-control" aria-label="Amount owed - can be overridden">-->
        </div>

        <ul  style="list-style-type:none;list-style:none;padding-left:0;">
        {% for error in payment_form.fee_due.errors  %}
            <li><label class="label label-danger">{{ error|striptags }}</label></li>
        {% endfor %}
        </ul>

    </div>

    <div class="row" style=" min-height: 80px;" >

        <div class="input-group panel-fluid panel-default col-xs-12 col-sm-10 {%if payment_form.fee_paid.errors %} has-error {%endif%}">

              <span class="input-group-addon">Fee Paid $</span>
            {% render_field payment_form.fee_paid class+="form-control" id="fee_paid"%}

              <!--<input id="fee_paid" type="text" class="form-control" aria-label="Actual amount member paid">-->
               <span class="input-group-btn">
                   <button class="btn btn-default "  > <span class="glyphicon glyphicon-remove btn-danger" aria-hidden="true"></span> Cancel</button>
                    <button class="btn btn-default" type="submit" >Done</button>
              </span>
        </div>

        <ul  style="list-style-type:none;list-style:none;padding-left:0;">
        {% for error in payment_form.fee_paid.errors  %}
            <li><label class="label label-danger">{{ error|striptags }}</label></li>
        {% endfor %}
        </ul>

    </div>
</form>

<script type="text/javascript">

$("#loanDurationRadioGroup").change(function(){UpdateFee()});

$( document ).ready(function(){UpdateFee()});

function UpdateFee()
{
    var fee_mult=parseFloat($("input[name='loan_duration']:checked","#loanDurationRadioGroup").val());
    var total=0.0;
   $("span[name='fee']","#toy_table")
   .each(

           function()
           {
                var originalValue=parseFloat(this.getAttribute("value"));
                var newValue=fee_mult*originalValue;

                this.innerHTML=newValue.toFixed(2);
                total+=newValue;
           }
   );
   document.getElementById("fee_due").value=total.toFixed(2);
}


</script>
{% endblock content %}

