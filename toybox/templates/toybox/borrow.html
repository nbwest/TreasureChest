{% extends "toybox/base.html" %}
{% load widget_tweaks %}
{% load templatetags %}
{% block content %}

{% include "toybox/change_fee.html" %}

<h1  id="page_table" class="page-header">Borrow Toy</h1>

<div id="member" class="row" >

    <div   class="col-xs-10 col-sm-10 ">

           {% include "toybox/member_search.html" with return_page="/toybox/borrow" %}
           {% include "toybox/member_search_select.html" with return_page="/toybox/borrow"%}

    </div>
    <div   class="col-xs-1" >

        <a href="{% url 'toybox:members' %}"><button title="Add New Member" type="button" class="btn btn-success" aria-label="Left Align">
        <span class="glyphicon glyphicon-plus " aria-hidden="true"></span><span class="glyphicon glyphicon-user " aria-hidden="true"></span></button></a>

    </div>
</div>

<div class="row" >
      <div class="col-xs-12 col-sm-10 " style="margin-left: 20px; ">
        <br>
           {% if members == None %}
                {% include "toybox/member_summary.html" %}
          {% endif %}
        <br>
      </div>

</div>


<div id="toy" class="row">

    <div   class="col-xs-12 col-sm-10 ">
        {% include "toybox/toy_search.html" %}
        {% include "toybox/toy_search_select.html" with return_page="/toybox/borrow"%}
    </div>

</div>

{% if toy %}
   <div class="row" >


        {% include "toybox/toy_summary.html" %}


   </div>
{%else%}
     <div class="row panel-fluid panel-default" ></div>
{% endif %}


<div id="transaction"  class="row">
    <div class="panel-default col-xs-12 col-sm-10 ">

              <div class="panel-heading">Borrowed Toys</div>

              <!-- Table -->
          <form action="{{ request.get_full_path }}" method='post'>
                {% csrf_token %}
              <table class="table" id="toy_table">

                    <thead>
                        <tr>
                            <th>Details</th>
                            <th>Toy ID</th>
                        	<th>Toy Name</th>
                            <th>Due</th>
                            <th>Borrow Fee</th>
                            <th>Remove</th>
                       	</tr>
                    </thead>

                  {% for toy in new_borrow_toy_list %}
                   <tr>
                       <td>
                           <button type="button" class="btn" data-toggle="collapse" data-target="#accordion_{{toy.id}}" ><span class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span></button>
                       </td>

                        <td>
                            <a href="{% url 'toybox:toys' toy_id=toy.id %}">{{ toy.code }}</a>
                                <span class="label label-success label-as-badge">New</span>
                        </td>

                        <td>{{ toy.name }}</td>

                        <td>
                            <span class="label label-success label-as-badge"><span name="new_toy_due">0</span> weeks</span>
                        </td>

                       <td>
                            $<span name="fee" value="{{toy.loan_type.loan_cost}}">{{ toy.loan_type.loan_cost|floatformat:2}}</span>
                       </td>

                        <td>
                            <button title="Remove this toy from list" name="remove_toy_{{toy.id}}" type="submit" onclick="UpdateBorrowFee()" class="btn btn-danger" aria-label="Left Align">
                                <span class="glyphicon glyphicon-trash " aria-hidden="true"></span>
                            </button>
                        </td>

                     </tr>



                    <tr>
                        <td colspan="6" style="border-top: none !important;">
                            <div id="accordion_{{toy.id}}" class="collapse">
                                 {% include "toybox/toy_summary.html" %}

                            </div>
                        </td>
                    </tr>
                   {% endfor %}


                   {% for toy in toy_list %}

                   <tr>
                        <td>
                           <button type="button" class="btn" data-toggle="collapse" data-target="#accordion_{{toy.id}}" ><span class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span></button>
                       </td>

                        <td>
                            <a href="{% url 'toybox:toys' toy_id=toy.id %}">{{ toy.code }}</a>
                        </td>

                        <td>{{ toy.name }}</td>

                        <td>
                            <span class="label {% if toy.due_date|timebetween|slice:':1' == '-' %} label-danger {%else%} label-success {%endif%} label-as-badge">{{ toy.due_date|timebetween}}</span>
                        </td>

                       <td>
                           N/A
                       </td>

                        <td>
                            <button title="Remove this toy from list" type="button" class="btn " aria-label="Left Align" disabled>
                                <span class="glyphicon glyphicon-trash " aria-hidden="true"></span>
                            </button>
                        </td>

                     </tr>

                    <tr>
                        <td colspan="6" style="border-top: none !important;">
                            <div id="accordion_{{toy.id}}" class="collapse">

                                   <!--TODO feed toy into toy_summary-->
                                {% include "toybox/toy_summary.html" %}


                           </div>

                        </td>
                    </tr>
                     {% endfor %}

              </table>
               </form>
        </div>


</div>



 <form role="form" action="{{ request.get_full_path }}" class="form-group" method='post'>
    {% csrf_token %}
    <div class="row" style=" min-height: 80px;margin-left: 0px;" >
        <div class="input-group  col-xs-12 col-sm-10 ">

            <span type="text" title="Loan duration in weeks for all newly borrowed toys"  class="input-group-addon">{{payment_form.loan_duration.label_tag|striptags}}</span>

              <div class="btn-group " name="loanDuration" data-toggle="buttons"  onchange="UpdateBorrowFee()" id="loanDurationRadioGroup">
                  {% for item in payment_form.loan_duration %}
                    <label class="btn btn-default{% if 'checked' in item.render %} active {% endif %}">{{ item }}</label>
                  {% endfor %}
              </div>
        </div>
    </div>


    {% for field in payment_form %}
        {%if field.field.widget.attrs.visible%}

         <div class="row col-xs-12 col-sm-10 " style=" min-height: 50px;" >

             {% if field.field.widget.attrs.hr %} <hr> {%endif%}

            <div class="input-group">
                <span class="input-group-addon">{{field.label_tag|striptags}} $</span>
                {% render_field field class+="form-control" id=field.auto_id   oninput+=")" oninput+=field.auto_id oninput+="UpdateFee(" %}

                 {% if field.field.widget.attrs.adjust_button %}
                <span class="input-group-btn">
                        <button type="button" class="btn btn-default" name="{{field.auto_id}}_adjust" data-toggle="modal" onclick='changeFee("{{field.auto_id}}")' data-target="#feeChangeModal">Adjust</button>
                   </span>
                {% endif %}

                {% if field.field.widget.attrs.change_buttons %}
                   <span class="input-group-btn">
                       <button class="btn btn-default" id="btn_return" name="return" type="submit" >Return</button>
                       <button class="btn btn-default" id="btn_donate" name="donate" type="submit" >Donate</button>
                       <button class="btn btn-default" id="btn_add_credit" name="add_credit" type="submit" >Add Credit</button>
                       <button class="btn btn-default" id="btn_use_credit" name="use_credit" type="submit" >Use Credit</button>
                       <button class="btn btn-default" id="btn_exact" name="exact" type="submit" >Exact</button>
                   </span>
                {% endif %}
                </div>

                 <ul  style="list-style-type:none;list-style:none;padding-left:0;">
                {% for error in field.errors  %}
                    <li><label class="label label-danger">{{ error|striptags }}</label></li>
                {% endfor %}
                </ul>
             </div>

        {% endif %}

    {% endfor %}

</form>



<script type="text/javascript">

//$("#loanDurationRadioGroup").change(function(){UpdateFee()});

$( document ).ready(function()
{
     UpdateBorrowFee();

});

function UpdateFee(id)
{

    CalcTotal(id);
    CalcChange(id);
}


function UpdateBorrowFee()
{
console.log("updateBorrowFee");
    var fee_mult=parseFloat($("input[name='loan_duration']:checked","#loanDurationRadioGroup").val());



    //console.log($("input[name='loan_duration']:checked","#loanDurationRadioGroup").val())
    //console.log(fee_mult)
    var total=0.0;

    //if (isNaN(fee_mult) break;

   $("span[name='fee']","#toy_table")
   .each(

           function()
           {
                var originalValue=parseFloat(this.getAttribute("value"));
                var newValue=fee_mult*originalValue;

                this.innerHTML=newValue.toFixed(2);
                total+=newValue;
           }
   );

   $("span[name='new_toy_due']","#toy_table")
   .each(
        function()
        {
           this.innerHTML=fee_mult;
        }
   );

   document.getElementById("id_borrow_fee").value=total.toFixed(2);
   UpdateFee();
}


function CalcTotal(id)
{
console.log("CalcTotal");
    var elements_to_total;
    var total=0.0;
    elements_to_total=document.querySelectorAll("[total_me=true]");

   nodes = Array.prototype.slice.call(elements_to_total,0);

  nodes.forEach(function(node){

        if (!isNaN(Number(node.value)))
        {
            total+= Number(node.value);
        }
  });

   var credit=Number({{payment_form.credit.value}});

    console.log("TOTAl: "+total);

   if (total!=0)
   {
       if (credit==0)
       {
            document.getElementById("id_credit").value="0.00";
            $("#btn_exact").prop('disabled',false);
            $("#btn_use_credit").prop('disabled',true);

       }
       else if (credit>total)
       {
            document.getElementById("id_credit").value=(credit-total).toFixed(2)+" - CREDIT USED, NO PAYMENT NECESSARY";
            document.getElementById("id_payment").value=total.toFixed(2);
            $("#btn_exact").prop('disabled',true);
            $("#btn_use_credit").prop('disabled',false);
       }
        else if (credit<total)
       {
            document.getElementById("id_credit").value="0.00 - REMAINING CREDIT USED FOR THIS TRANSACTION";
            $("#btn_exact").prop('disabled',false);
            $("#btn_use_credit").prop('disabled',true);
            total=total-credit;
            console.log("TOTAL: "+total);
       }
    }
    else
    {
        document.getElementById("id_credit").value=credit.toFixed(2);
        document.getElementById("id_payment").value=(0).toFixed(2);
        //document.getElementById("id_total_fee").value=0.toFixed(2);
    }

    document.getElementById("id_total_fee").value=total.toFixed(2);
}

function CalcChange(id)
{
console.log("CalcChange");
    var total=Number(document.getElementById("id_total_fee").value);
    var paid=Number(document.getElementById("id_payment").value);
    var change=paid-total;
    var credit=Number({{payment_form.credit.value}});

    console.log("CHANGE: "+change);
    console.log("PAID: "+paid);
    console.log("CREDIT: "+credit);
    console.log("TOTAL: "+total);

    document.getElementById("id_change").value=change.toFixed(2);



    $("#btn_exact").prop('disabled', (change!=0)|(change<0)|(isNaN(change))|(credit>total));
    $("#btn_add_credit").prop('disabled', (change<=0)|(isNaN(change)));
    $("#btn_donate").prop('disabled', (change<=0)|(isNaN(change)));
    $("#btn_return").prop('disabled', (change<=0)|(isNaN(change)));
    $("#btn_use_credit").prop('disabled', (total==0)|(isNaN(change)));



}



</script>
{% endblock content %}

