{% extends "toybox/base.html" %}
{% load widget_tweaks %}
{% load templatetags %}
{% block content %}

{% include "toybox/change_fee.html" %}

{%if success%}
    {% include "toybox/success_message.html" with success_message="Transaction sucessful" %}
{%endif%}


<h1  id="page_table" class="page-header">Borrow Toy</h1>

<div id="member" class="row" >

    <div   class="col-xs-12 col-sm-10 ">
           {% include "toybox/member_search.html" with return_page="/toybox/borrow" %}
           {% include "toybox/member_search_select.html" with return_page="/toybox/borrow"%}
    </div>

    <div   class="col-xs-1" >
        <a href="{% url 'toybox:members' %}"><button title="Add New Member" type="button" class="btn btn-success" aria-label="Left Align">
        <span class="glyphicon glyphicon-plus " aria-hidden="true"></span><span class="glyphicon glyphicon-user " aria-hidden="true"></span></button></a>
    </div>

</div>

<div class="row" >

      <div class="col-xs-12 col-sm-10 " style="margin-left: 20px; ">
        <br>
           {% if members == None %}
                {% include "toybox/member_summary.html" %}
          {% endif %}
        <br>
      </div>

</div>


<div id="toy" class="row">

    <div   class="col-xs-12 col-sm-10 ">
        {% include "toybox/toy_search.html" %}
        {% include "toybox/toy_search_select.html" with return_page="/toybox/borrow"%}
    </div>

</div>

{% if toy %}
      {% include "toybox/toy_summary.html" %}
{%else%}
     <div class="row panel-fluid panel-default" ></div>
{% endif %}

<form role="form" action="{{ request.get_full_path }}" class="form-group" method='post'>
    {% csrf_token %}
    <div id="transaction"  class="row">
        <div class="panel-default col-xs-12 col-sm-10 ">

              <div class="panel-heading">Borrowed Toys</div>

              <table class="table" id="toy_table">

                    <thead>
                        <tr>
                            <th>Details</th>
                            <th>Toy ID</th>
                        	<th>Toy Name</th>
                            <th>Due</th>
                            <th style="text-align: center;vertical-align: middle;">Borrow Fee</th>
                            {% if loan_bond_enable == "true" %}
                            <th style="text-align: center;vertical-align: middle;">Bond</th>
                            {%endif%}
                            <th style="text-align: center;vertical-align: middle;">Lend for repair</th>
                            <th>Remove</th>
                       	</tr>
                    </thead>

                  {% for toy in new_borrow_toy_list %}
                   <tr>
                       <td>
                           <button type="button" class="btn" data-toggle="collapse" data-target="#accordion_{{toy.id}}" ><span class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span></button>
                       </td>

                        <td>
                            <a href="{% url 'toybox:toys' toy_id=toy.id %}">{{ toy.code }}</a>
                                <span class="label label-success label-as-badge">New</span>
                        </td>

                        <td>{{ toy.name }}</td>

                        <td>
                            <span class="label label-success label-as-badge"><span name="new_toy_due" toy_id="{{toy.id}}">0</span> weeks</span>
                        </td>

                       <td style="text-align: center;vertical-align: middle;">
                            <span id="fee_{{toy.id}}" toy_id="{{toy.id}}" name="fee" value="{{toy.loan_cost}}">{{ toy.loan_cost|floatformat:2}}</span>
                       </td>

                       {% if loan_bond_enable == "true" %}
                        <td style="text-align: center;vertical-align: middle;">
                            <span id="loan_bond_{{toy.id}}" toy_id="{{toy.id}}" name="loan_bond" value="{{toy.loan_bond}}">{{ toy.loan_bond|floatformat:2}}</span>
                       </td>
                       {% endif %}

                        <td style="text-align: center;vertical-align: middle;">
                            {%if toy.state == toy.TO_BE_REPAIRED %}
                                {% form_field_concat_id payment_form "repair_checkbox_" toy.id name="repair_checkbox_^suffix^" class="form-control" onclick="UpdateFee()"%}
                            {%else%}
                                N/A
                            {%endif%}
                        </td>

                        <td>
                            <a title="Remove this toy from list" name="remove_toy_{{toy.id}}" type="submit" onclick="UpdateFee()" class="btn btn-danger" aria-label="Left Align">
                                <span class="glyphicon glyphicon-trash " aria-hidden="true"></span>
                            </a>
                        </td>

                     </tr>



                    <tr>
                        <td colspan="8" style="border-top: none !important;">
                            <div id="accordion_{{toy.id}}" class="collapse">
                                 {% include "toybox/toy_summary.html" %}

                            </div>
                        </td>
                    </tr>
                   {% endfor %}


                   {% for toy in toy_list %}

                   <tr>
                        <td>
                           <button type="button" class="btn" data-toggle="collapse" data-target="#accordion_{{toy.id}}" ><span class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span></button>
                       </td>

                        <td>
                            <a href="{% url 'toybox:toys' toy_id=toy.id %}">{{ toy.code }}</a>
                        </td>

                        <td>{{ toy.name }}</td>

                        <td>
                            <span class="label {% if toy.due_date|timebetween|slice:':1' == '-' %} label-danger {%else%} label-success {%endif%} label-as-badge">{{ toy.due_date|timebetween}}</span>
                        </td>

                       <td style="text-align: center;vertical-align: middle;">
                           N/A
                       </td>

                       <td style="text-align: center;vertical-align: middle;">
                           N/A
                       </td>
                        {% if loan_bond_enable == "true" %}
                        <td style="text-align: center;vertical-align: middle;">
                            N/A
                        </td>
                       {%endif%}

                        <td>
                            <button title="Remove this toy from list" type="button" class="btn " aria-label="Left Align" disabled>
                                <span class="glyphicon glyphicon-trash " aria-hidden="true"></span>
                            </button>
                        </td>

                     </tr>

                    <tr>
                        <td colspan="8" style="border-top: none !important;">
                            <div id="accordion_{{toy.id}}" class="collapse">

                                   <!--TODO feed toy into toy_summary-->
                                {% include "toybox/toy_summary.html" %}


                           </div>

                        </td>
                    </tr>
                     {% endfor %}

              </table>

        </div>
    </div>

    <div class="row" style=" min-height: 80px;margin-left: 0px;" >
        <div class="input-group  col-xs-12 col-sm-10 ">

            <span type="text" title="Loan duration in weeks for all newly borrowed toys"  class="input-group-addon">{{payment_form.loan_duration.label_tag|striptags}}</span>

              <div class="btn-group " name="loanDuration" data-toggle="buttons"  onchange="UpdateFee()" id="loanDurationRadioGroup">
                  {% for item in payment_form.loan_duration %}
                    <label class="btn btn-default{% if 'checked' in item.render %} active {% endif %}">{{ item }}</label>
                  {% endfor %}
              </div>
        </div>
    </div>


    {% for field in payment_form %}

        {%if field.field.widget.attrs.type == "hidden" %}
            {% render_field field class+="form-control" id=field.auto_id  %}

        {%elif field.field.widget.attrs.enabled%}
            <div class="row">
             <div class="col-xs-12 col-sm-10 " style=" min-height: 50px;" >

                 {% if field.field.widget.attrs.hr %}
                    <hr>
                 {%endif%}

                 <div class="input-group  {% if field.field.widget.attrs.large %} input-group-lg {% endif %}">


                    <span class="input-group-addon " id="label_{{field.auto_id}}">{{field.label_tag|striptags}} $</span>

                    {% render_field field class+="form-control" id=field.auto_id   oninput+=")" oninput+=field.auto_id oninput+="UpdateFee(" %}

                     {% if field.field.widget.attrs.adjust_button %}
                    <span class="input-group-btn">
                            <button type="button" class="btn btn-default" name="{{field.auto_id}}_adjust" data-toggle="modal" onclick='changeFee("{{field.auto_id}}")' data-target="#feeChangeModal">Adjust</button>
                    </span>
                    {% endif %}

                    {% if field.field.widget.attrs.change_buttons %}
                       <span class="input-group-btn">

                           <button class="btn btn-default" id="btn_paid" name="paid" type="submit" >Paid</button>
                           {% if donation_enable == "true" %}
                           <button class="btn btn-default" id="btn_donate" name="donate" type="submit" >Donate</button>
                           {%endif%}

                           {% if credit_enable == "true" %}
                           <button class="btn btn-default"  id="btn_credit" name="add_credit" type="submit" >Credit</button>
                           {%endif%}

                       </span>
                    {% endif %}


                    {% if field.field.widget.attrs.cancel_button %}
                       <span class="input-group-btn">
                           <button class="btn btn-default" id="btn_cancel" name="cancel" type="submit" >Cancel</button>
                       </span>
                    {% endif %}

                 </div>

                 <ul  style="list-style-type:none;list-style:none;padding-left:0;">
                     {% for error in field.errors  %}
                        <li><label class="label label-danger">{{ error|striptags }}</label></li>
                     {% endfor %}
                 </ul>

             </div>
            </div>
        {% endif %}

    {% endfor %}
</form>




<script type="text/javascript">

var enable_exact_for_repair_only=false;

$( document ).ready(function()
{
     UpdateFee();

});

function UpdateFee()
{
    UpdateBorrowFee();
    UpdateLoanBond();
    CalcTotal();
}

function UpdateBorrowFee()
{
    var fee_mult=parseFloat($("input[name='loan_duration']:checked","#loanDurationRadioGroup").val());
    var total=0.0;
    var toys_checked=0;
    var total_new_toys={{new_borrow_toy_list|length}};

   $("span[name='fee']","#toy_table")
   .each(

           function()
           {
                var originalValue=parseFloat(this.getAttribute("value"));
                var newValue=fee_mult*originalValue;
                var toy_id=this.getAttribute("toy_id");


                //exclude if lending for repair
                var repair_checkbox=document.getElementById("repair_checkbox_"+toy_id);

                if (repair_checkbox!=null)
                {
                    if (repair_checkbox.checked)
                    {
                        toys_checked++;
                        newValue=0;
                    }
                }
                this.innerHTML="$"+newValue.toFixed(2);
                total+=newValue;
           }
   );

   enable_exact_for_repair_only=(total_new_toys==toys_checked) && (total_new_toys>0);

   $("span[name='new_toy_due']","#toy_table")
   .each(
        function()
        {
            //extend time if lending for repair
            var toy_id=this.getAttribute("toy_id");
            var repair_checkbox=document.getElementById("repair_checkbox_"+toy_id);

            due=fee_mult;
            if (repair_checkbox!=null)
            {
                if (repair_checkbox.checked)
                   due={{repair_loan_duration}};
            }

           this.innerHTML=due;
        }
   );

   document.getElementById("id_borrow_fee").value=total.toFixed(2);


}

function UpdateLoanBond()
{
    var total=0.0;

   $("span[name='loan_bond']","#toy_table")
   .each(

           function()
           {
                var value=parseFloat(this.getAttribute("value"));
                var toy_id=this.getAttribute("toy_id");
                var repair_checkbox=document.getElementById("repair_checkbox_"+toy_id);

                if (repair_checkbox!=null)
                {
                    if (repair_checkbox.checked)
                    {
                      value=0;
                    }
                }

                this.innerHTML="$"+value.toFixed(2);
                total+=value;
           }
   );


   var loan_bond=document.getElementById("id_loan_bond");
   if (loan_bond != null)
    loan_bond.value=total.toFixed(2);

}


function CalcTotal()
{
    var elements_to_total;
    var total=0.0, fees=0.0, change=0.0, payment=0.0;
    elements_to_total=document.querySelectorAll("[total_me=positive],[total_me=negative]");

    nodes = Array.prototype.slice.call(elements_to_total,0);
//console.log("----------------------");
    nodes.forEach(function(node){

        if (!isNaN(Number(node.value)))
        {
            //console.log(node.attributes.getNamedItem("total_me").value+", VAL: "+node.value);
            if (node.attributes.getNamedItem("total_me").value=='positive')
                fees+= Number(node.value);
            else
                fees-= Number(node.value);
        }
    });



   var credit=Number("{{payment_form.credit.value}}");
   var payment=Number(document.getElementById("id_payment").value);
   var change_label=document.getElementById("label_id_change");

//console.log("----------------------");
    //console.log("FEES: "+fees);
    //console.log("CREDIT: "+credit);
    //console.log("TOTAL: "+total);
    //console.log("CHANGE: "+change);
    //console.log("PAYMENT: "+payment);


   var A=(fees<credit),B=(fees==credit),C=(fees>credit),D=(fees<0), E=(fees==0), F=(fees>0), G=(credit>0),H=(credit==0);

   var total_eq_0 = (B && E && !G) || (A && !D && !H) || (!C && F && !H);
   var total_eq_fees = (A && D) || (C && F && !G);
   var total_eq_fees_minus_credit = (C && F && !H);

   var change_eq_pay_minus_total =  (C && F);
   var change_eq_0 = (!C && F && !H) || (!C && E && !G);
   var change_eq_minus_fees = (A && D);

   var payment_eq_0 = !(C && F);

   var credit_eq_0 = (C && F && !H);
   var credit_eq_credit_minus_fees = (!C && F && !H);

//console.log("total_eq_fees: "+total_eq_fees);
//console.log("(A && !D && !H): "+(A && !D && !H));
//console.log("(!C && F && !H): "+(!C && F && !H));

    if (total_eq_0)
        total=0;
    else if (total_eq_fees)
        total=fees;
    else if (total_eq_fees_minus_credit)
        total=fees-credit;



   if (change_eq_pay_minus_total)
        change=payment-total;
   else if (change_eq_0)
        change=0;
   else if (change_eq_minus_fees)
   {
        change = -fees;

        //change label
        change_label.innerHTML="Refund: $";
        $("#label_id_change").addClass('label-warning');
   }
    else
    {
        change_label.innerHTML="Change: $";
        $("#label_id_change").removeClass('label-warning');
    }


    if (payment_eq_0)
        document.getElementById("id_payment").value=(0).toFixed(2);

    if (credit_eq_0)
        credit=0;
    else if (credit_eq_credit_minus_fees)
        credit=credit-fees;

    //console.log("----------------------");
    //console.log("FEES: "+fees);
    //console.log("CREDIT: "+credit);
    //  console.log("TOTAL: "+total);
    //console.log("CHANGE: "+change);
    //console.log("PAYMENT: "+payment);
    //console.log("repair only:"+enable_exact_for_repair_only);


    document.getElementById("id_total_fee").value=fees.toFixed(2);

    if (document.getElementById("id_total_to_pay")!=null)
        document.getElementById("id_total_to_pay").value=total.toFixed(2);

    document.getElementById("id_change").value=change.toFixed(2);

    if (document.getElementById("id_credit")!=null)
        document.getElementById("id_credit").value=credit.toFixed(2);

     $("#btn_paid").prop('disabled', (isNaN(change)) || (total==0 && fees==0) || (!(change>=0) && !enable_exact_for_repair_only));
   // $("#btn_exact").prop('disabled', (isNaN(change)) || (!(payment==total && total!=0) && !enable_exact_for_repair_only));
   if ("{{credit_enable}}"=="true")
        $("#btn_credit").prop('disabled',(isNaN(change)) || (total==0 && fees==0) || !((payment+credit)-total>0) );


    if ("{{donation_enable}}" == "true")
        $("#btn_donate").prop('disabled',(isNaN(change)) || (total==0) || !((payment+credit)-total>0) );

   // $("#btn_return").prop('disabled',(isNaN(change)) || (total==0) || !((payment+credit)-total>0) );


}



</script>
{% endblock content %}

